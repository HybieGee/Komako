---
import BaseLayout from '@layouts/BaseLayout.astro';
import Timeline from '@components/Timeline.astro';
import type { TimelineItem } from '@components/Timeline.astro';
import { getPhotos, getAlbums, getJournalPosts } from '@lib/content';
import { useTranslations } from '@lib/i18n';

const lang = 'ja';
const t = useTranslations(lang);

const photos = await getPhotos(lang);
const albums = await getAlbums(lang);
const posts = await getJournalPosts(lang);

const timelineItems: TimelineItem[] = [
  ...photos.map(photo => ({
    date: photo.date,
    title: photo.title,
    description: photo.tags?.join(', '),
    image: photo.image,
    link: `/ja/photo/${photo.slug}`,
    type: 'photo' as const,
  })),
  ...albums.map(album => ({
    date: album.date || '2025-01-01',
    title: album.title,
    description: album.summary,
    image: album.cover,
    link: `/ja/albums/${album.slug}`,
    type: 'album' as const,
  })),
  ...posts.map(post => ({
    date: post.date,
    title: post.title,
    description: post.excerpt,
    link: `/ja/journal/${post.slug}`,
    type: 'journal' as const,
  })),
  {
    date: '2021-03-26',
    title: 'コマコが誕生しました！',
    description: 'スコティッシュフォールドとの旅が始まります',
    type: 'milestone' as const,
  },
].sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());
---

<BaseLayout
  title={`${t('timeline.title')} - コマコギャラリー`}
  description={t('timeline.subtitle')}
  lang={lang}
>
  <div class="container py-8">
    <header class="mb-8">
      <h1 class="text-3xl font-bold">{t('timeline.title')}</h1>
      <p class="mt-2 text-komako-soft">
        {t('timeline.subtitle')}
      </p>
    </header>
    
    <Timeline items={timelineItems} />
    
    <div id="load-more-container" class="mt-8 text-center">
      <button id="load-more" class="btn-secondary">
        もっと読む
      </button>
    </div>
  </div>
</BaseLayout>

<script>
  let visibleItems = 20;
  const itemsPerLoad = 20;
  const allTimelineItems = document.querySelectorAll('.timeline-item');
  const loadMoreBtn = document.getElementById('load-more');
  const loadMoreContainer = document.getElementById('load-more-container');
  
  function showItems() {
    allTimelineItems.forEach((item, index) => {
      if (index < visibleItems) {
        (item as HTMLElement).style.display = 'flex';
      } else {
        (item as HTMLElement).style.display = 'none';
      }
    });
    
    if (visibleItems >= allTimelineItems.length && loadMoreContainer) {
      loadMoreContainer.style.display = 'none';
    }
  }
  
  loadMoreBtn?.addEventListener('click', () => {
    visibleItems += itemsPerLoad;
    showItems();
  });
  
  showItems();
</script>